# SuiteManager - Contexto Completo para Claude

## ðŸŽ¯ VisiÃ³n del Negocio

### Propuesta de Valor
Centralizar TODOS los canales de venta de propiedades de arriendo a corto plazo en una sola aplicaciÃ³n, permitiendo:
- GestiÃ³n unificada de reservas de mÃºltiples OTAs
- CRM con marketing personalizado
- Motor de reservas directas (reducir comisiones OTAs)
- Co-anfitriones con sistema de comisiones

### Modelo de Negocio
- **Target**: Empresas de cabaÃ±as en PucÃ³n, Chile (luego expansiÃ³n)
- **Pricing**: $300.000 CLP/aÃ±o por empresa
- **Meta**: 1,000 usuarios = $300M CLP/aÃ±o

### Arquitectura de Dos Mundos (SEPARACIÃ“N CRÃTICA)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ”µ SPA (Panel Admin - /admin-assets)          â”‚
â”‚  Puerto de entrada: /                          â”‚
â”‚  Usuarios: Administradores de empresas         â”‚
â”‚  Funciones: GestiÃ³n, CRM, Config, Sync OTAs    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸŸ¢ SSR (Web PÃºblica - /public-assets)         â”‚
â”‚  Puerto de entrada: / (segÃºn dominio/subdom)   â”‚
â”‚  Usuarios: Clientes finales + Co-anfitriones   â”‚
â”‚  Funciones: Reservas directas, SEO, Integr. IA â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**IMPORTANTE**: Mantener lÃ³gicas COMPLETAMENTE separadas. Si una feature afecta ambos mundos, crear servicios duplicados pero independientes.

---

## ðŸ—ï¸ Principios ArquitectÃ³nicos CRÃTICOS

### 1. Multi-Tenant (Aislamiento Total)
```javascript
// âœ… SIEMPRE
db.collection('empresas').doc(empresaId).collection('reservas')

// âŒ NUNCA
db.collection('reservas')
```

### 2. Sistema ParamÃ©trico (Flexibilidad sin CÃ³digo)
**TODO debe ser configurable desde la UI**:
- âœ… Canales de venta (nombre, comisiones, modificadores)
- âœ… Estados de gestiÃ³n y reserva
- âœ… Mapeo de CSV (separadores, formatos, reglas de comisiÃ³n/IVA)
- âœ… Tarifas por temporada
- âœ… Valores de dÃ³lar histÃ³ricos

**NO hardcodear valores de negocio en el cÃ³digo**.

### 3. Fuente de la Verdad (Inmutabilidad Financiera)
- `valores.valorHuesped` (CLP) = **INMUTABLE** (viene de reporte o ajuste manual)
- Motor de tarifas calcula KPIs (comparativa), **NUNCA sobrescribe valores reales**
- Ajustes de precio: ExplÃ­citos (Propuesta, GestiÃ³n Diaria, Gestionar Reservas)
- Trazabilidad: Historial de ajustes con usuario, fecha, valor anterior/nuevo

### 4. Integridad de Reservas (No Duplicados)
**Prioridad de fuentes**:
1. **Manual** (usuario crea/edita) â†’ MÃ¡xima prioridad
2. **iCal** (sincronizaciÃ³n calendario) â†’ Crea "fantasma" (estado: Propuesta)
3. **Reporte CSV** (OTA) â†’ Actualiza iCal si existe, crea si no

**LÃ³gica**: Si iCal + Reporte coinciden (fechas, propiedad), el reporte "completa" el iCal sin duplicar.

---

## ðŸ“ SeparaciÃ³n de Responsabilidades

```
backend/
  â”œâ”€â”€ services/              â† LÃ³gica pura (sin req/res)
  â”‚   â”œâ”€â”€ [entidad]Service.js    (ej: reservasService.js)
  â”‚   â”œâ”€â”€ publicWebsiteService.js  â† SSR (separado)
  â”‚   â””â”€â”€ utils/
  â”œâ”€â”€ routes/
  â”‚   â”œâ”€â”€ api/              â† SPA (admin)
  â”‚   â”œâ”€â”€ website.js        â† SSR (pÃºblico)
  â”‚   â””â”€â”€ integrations/     â† Google Hotels, APIs externas
  â”œâ”€â”€ middleware/
  â”‚   â”œâ”€â”€ authMiddleware.js      â† SPA (JWT)
  â”‚   â””â”€â”€ tenantResolver.js      â† SSR (dominio/subdominio)
  â””â”€â”€ config/
      â””â”€â”€ idUpdateManifest.js    â† DefiniciÃ³n de cascadas

frontend/src/              â† SPA SOLAMENTE
  â”œâ”€â”€ views/               â† Orquestadores
  â”œâ”€â”€ views/components/    â† Componentes especÃ­ficos por vista
  â”œâ”€â”€ api.js               â† Cliente HTTP
  â””â”€â”€ router.js            â† NavegaciÃ³n

backend/views/             â† SSR (EJS templates)
  â”œâ”€â”€ home.ejs
  â”œâ”€â”€ propiedad.ejs
  â””â”€â”€ checkout.ejs
```

---

## ðŸ’° Modelo de Datos Financieros

### Estructura de Valores
```javascript
{
  moneda: 'USD' | 'CLP',  // Moneda del canal
  valores: {
    // Moneda Original (del reporte)
    valorHuespedOriginal: 100.00,
    valorTotalOriginal: 85.00,     // Payout
    comisionOriginal: 15.00,
    ivaOriginal: 0,
    
    // ConversiÃ³n a CLP
    valorHuesped: 95000,           // â† FUENTE DE VERDAD (cobro cliente)
    valorTotal: 80750,             // Payout en CLP
    comision: 14250,
    iva: 0,
    
    // Referencia (KPI)
    valorOriginal: 110.00,         // Precio base segÃºn tarifas
    valorDolarFacturacion: 950     // DÃ³lar fijado (si facturado)
  },
  historialAjustes: [              // Trazabilidad
    {
      fuente: 'Gestionar Reservas (Editar)',
      usuarioEmail: 'admin@empresa.com',
      fecha: Timestamp,
      valorAnteriorUSD: 100,
      valorNuevoUSD: 95,
      ajusteUSD: -5,
      valorDolarUsado: 950
    }
  ]
}
```

### ConversiÃ³n Fijo/Flotante
- **Flotante**: Reservas futuras/no facturadas â†’ dÃ³lar actual
- **Fijo**: Reservas pasadas/facturadas â†’ dÃ³lar histÃ³rico (guardado en valorDolarFacturacion)

---

## ðŸ”— Grupos de Reservas (Multi-Alojamiento)

**Concepto**: Una reserva puede incluir mÃºltiples propiedades (ej: cabaÃ±a + quincho).

**Identificador**: `idReservaCanal` (viene del reporte, ej: "ABC123")

**Datos Compartidos** (a nivel de grupo):
- Cliente (clienteId)
- Transacciones/Pagos (reservaIdOriginal = idReservaCanal)
- Notas de bitÃ¡cora (reservaIdOriginal = idReservaCanal)

**Datos Individuales** (por reserva):
- Alojamiento (propiedadId)
- Fechas (fechaLlegada, fechaSalida)
- Valores financieros (cada propiedad tiene su precio)
- Documentos (enlaceReserva, enlaceBoleta)

---

## ðŸ—„ï¸ Estructura Firestore

```
empresas/{empresaId}/
  â”œâ”€â”€ (documento raÃ­z)
  â”‚   â”œâ”€â”€ nombre: string
  â”‚   â””â”€â”€ websiteSettings: {domain, subdomain, googleAnalyticsId, ...}
  â”‚
  â”œâ”€â”€ users/
  â”œâ”€â”€ clientes/              â† CRM
  â”œâ”€â”€ reservas/              â† idReservaCanal agrupa reservas
  â”œâ”€â”€ transacciones/         â† reservaIdOriginal vincula al grupo
  â”œâ”€â”€ gestionNotas/          â† reservaIdOriginal vincula al grupo
  â”œâ”€â”€ propiedades/
  â”‚   â””â”€â”€ {propiedadId}
  â”‚       â”œâ”€â”€ componentes: array  â† Definidos por usuario (ej: "Dormitorio Principal")
  â”‚       â”œâ”€â”€ websiteData: {aiDescription, images: {componentId: [...]}}
  â”‚       â””â”€â”€ googleHotelData: {hotelId, address, ...}
  â”œâ”€â”€ canales/               â† ParamÃ©trico (usuarios pueden agregar)
  â”‚   â””â”€â”€ {canalId}
  â”‚       â”œâ”€â”€ nombre: string
  â”‚       â”œâ”€â”€ esCanalPorDefecto: boolean
  â”‚       â”œâ”€â”€ modificadorTipo: 'porcentaje' | 'fijo'
  â”‚       â”œâ”€â”€ modificadorValor: number
  â”‚       â”œâ”€â”€ configuracionIva: 'incluido' | 'excluido'
  â”‚       â””â”€â”€ mapeoCSV: {separador, formatoFecha, comisionIncluida, ...}
  â”œâ”€â”€ tarifas/               â† Tarifa Base + Modificadores por canal
  â”œâ”€â”€ valoresDolar/          â† HistÃ³rico (clave: fecha-YYYY-MM-DD)
  â”œâ”€â”€ historialCargas/       â† AuditorÃ­a de CSV subidos
  â”œâ”€â”€ campanas/              â† Marketing CRM
  â””â”€â”€ cupones/               â† Descuentos para clientes
```

---

## ðŸŽ¨ Reglas de CodificaciÃ³n (NO NEGOCIABLES)

### General
1. **Archivos completos SIEMPRE**: Nunca `// ... cÃ³digo existente`
2. **Sin comentarios en funciones**: CÃ³digo autoexplicativo
3. **Mantener estilo**: Respetar convenciones, indentaciÃ³n
4. **Todos los archivos**: Si modifico N archivos, entregar N completos

### Backend: Servicios Puros
```javascript
// âœ… CORRECTO
const obtenerReservas = async (db, empresaId) => {
    const snapshot = await db.collection('empresas')
        .doc(empresaId).collection('reservas').get();
    return snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
};

// âŒ INCORRECTO: LÃ³gica en routes
router.get('/reservas', async (req, res) => {
    const snapshot = await db.collection(...).get();
    res.json(...);
});
```

### Frontend: GestiÃ³n de Errores Estructurados
```javascript
// En api.js
const error = new Error(errorData.error);
error.status = response.status;
error.data = errorData.data;
throw error;

// En vistas
try {
    await fetchAPI('/reservas', {method: 'DELETE'});
} catch (error) {
    if (error.status === 409 && error.data) {
        // Mostrar modal de confirmaciÃ³n
    }
}
```

---

## ðŸ”§ CaracterÃ­sticas Especiales

### 1. SincronizaciÃ³n iCal (Sin Duplicados)
**Flujo**:
1. Usuario sincroniza iCal â†’ Crea reservas "fantasma" (origen: 'ical', estado: 'Propuesta')
2. Usuario sube CSV de OTA â†’ Sistema busca reserva iCal con mismas fechas/propiedad
3. Si encuentra: Actualiza iCal â†’ origen: 'reporte', completa datos faltantes
4. Si no: Crea nueva reserva

**Campos Protegidos** (no se sobrescriben si fueron editados manualmente):
- Guardados en `edicionesManuales: {campo: true}`

### 2. Mapeo ParamÃ©trico de CSV
Cada canal tiene configuraciÃ³n:
```javascript
{
  separador: ',' | ';',
  formatoFecha: 'DD/MM/YYYY' | 'MM/DD/YYYY' | ...,
  formatoNumero: 'punto' | 'coma',
  comisionIncluida: boolean,
  ivaIncluido: boolean,
  camposMapeo: {
    idReserva: 'Booking ID',
    fechaLlegada: 'Check-in',
    valorTotal: 'Total Price',
    ...
  }
}
```

### 3. Motor de Tarifas (Base + Modificadores)
- **Tarifa Base**: Un precio por temporada/propiedad/canal por defecto
- **Modificadores**: Otros canales aplican % o monto fijo sobre la base
- **CÃ¡lculo en Tiempo Real**: Para propuestas y presupuestos
- **No Sobrescribe**: Valores de reportes se guardan como referencia (KPI)

### 4. CRM y Marketing
- **SegmentaciÃ³n RFM**: AutomÃ¡tica (Recencia, Frecuencia, Valor Monetario)
- **CampaÃ±as**: Por segmento, con cupones de un solo uso
- **WhatsApp Directo**: Via Google Contacts (sin API de WhatsApp)
- **Scraping de Comentarios**: Por ID de reserva de cualquier canal

### 5. Co-anfitriones (Futura ExpansiÃ³n)
- Generan reservas con cÃ³digo Ãºnico
- Sistema calcula comisiÃ³n automÃ¡ticamente
- Seguimiento de conversiones por co-anfitriÃ³n

### 6. SSR (Motor de Reservas PÃºblicas)
**OptimizaciÃ³n**:
- Gemini genera textos SEO, robot.txt, sitemap
- ImÃ¡genes: WebP optimizadas con sharp
- Metadatos dinÃ¡micos por propiedad (og:tags, JSON-LD)

**IntegraciÃ³n**:
- Google Hotels: Feeds XML (Property Data + ARI)
- Deep Linking: Pre-selecciÃ³n de fechas desde Google
- Preparado para: ChatGPT, Claude, otros agentes IA

---

## ðŸ“¦ Archivos CrÃ­ticos

### Backend (SPA + SSR)
- `services/reservasService.js`: CRUD + eliminaciÃ³n en cascada
- `services/dolarService.js`: ConversiÃ³n fijo/flotante
- `services/publicWebsiteService.js`: LÃ³gica SSR (SEPARADA)
- `config/idUpdateManifest.js`: Cascadas de actualizaciÃ³n
- `middleware/authMiddleware.js`: JWT (SPA)
- `middleware/tenantResolver.js`: Dominio/Subdominio (SSR)

### Frontend SPA
- `api.js`: Cliente HTTP con errores estructurados
- `router.js`: NavegaciÃ³n SPA
- `views/gestionDiaria.js`: Vista principal operativa
- `views/gestionarReservas.js`: GestiÃ³n completa con modales
- `views/configurarWebPublica.js`: Config SSR desde SPA

### Templates SSR (EJS)
- `backend/views/home.ejs`
- `backend/views/propiedad.ejs`
- `backend/views/checkout.ejs`

---

## ðŸš€ Features Implementadas âœ…

- Arquitectura multi-empresa
- CRUD de reservas con grupos
- EliminaciÃ³n en cascada (Firestore + Storage)
- Sistema de tarifas base + modificadores
- ConversiÃ³n multi-moneda (fijo/flotante)
- Trazabilidad de ajustes financieros
- CRM con segmentaciÃ³n RFM
- CampaÃ±as y cupones
- GestiÃ³n diaria con flujo de estados
- SincronizaciÃ³n de reportes CSV (paramÃ©trica)
- SincronizaciÃ³n iCal (sin duplicados)
- Motor de reservas SSR
- IntegraciÃ³n Google Hotels (feeds XML)
- OptimizaciÃ³n SEO con IA (Gemini)

## ðŸ”„ PrÃ³ximos Pasos

- Dashboard con KPIs (ADR, RevPAR, OcupaciÃ³n)
- Generador de presupuestos mejorado
- Sistema de co-anfitriones con comisiones
- IntegraciÃ³n con agentes IA (ChatGPT, Claude) para reservas
- Scraping de comentarios automatizado
- Notificaciones por email (cambios de estado)

---

## âš™ï¸ Comandos

```bash
npm run dev              # Desarrollo local (backend)
git push origin main     # Deploy automÃ¡tico en Render
```

---

## ðŸ’¡ FilosofÃ­a de Desarrollo

> "Si el usuario no puede parametrizar algo desde la UI, 
> estamos limitando el potencial del sistema."

**Objetivo**: Crear una plataforma donde agregar canales, modificar flujos o cambiar reglas de negocio sea TAN SIMPLE como llenar un formulario.