<%# backend/views/partials/property-card.ejs %>
    <% const imagenTarjeta=prop.websiteData?.cardImage; const imagenUrl=imagenTarjeta?.storagePath
        || 'https://via.placeholder.com/400x300.png?text=Imagen+principal+no+disponible' ; const
        altText=imagenTarjeta?.altText || `Imagen de ${prop.nombre}`; const titleText=imagenTarjeta?.title ||
        prop.nombre; const descripcion=prop.websiteData?.aiDescription || prop.descripcion
        || 'Descripción no disponible.' ; const tienePrecio=isSearchResult && prop.pricing && typeof
        prop.pricing.totalPriceCLP==='number' && prop.pricing.totalPriceCLP> 0;
        let abono = tienePrecio ? prop.pricing.totalPriceCLP * 0.10 : 0;
        const formatCurrency = (value) => `$${(Math.round(value) || 0).toLocaleString('es-CL')}`;
        %>
        <div
            class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col h-full hover:shadow-xl transition-shadow duration-300">
            <a href="/propiedad/<%= prop.id %>?fechaLlegada=<%= query.fechaLlegada || '' %>&fechaSalida=<%= query.fechaSalida || '' %>&personas=<%= query.personas || '' %>"
                class="block relative h-48 overflow-hidden">
                <picture>
                    <source srcset="<%= imagenUrl %>" type="image/webp">
                    <img src="<%= imagenUrl %>" alt="<%= altText %>" title="<%= titleText %>" loading="lazy"
                        class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
                </picture>
            </a>
            <div class="p-4 flex flex-col flex-grow">
                <div class="flex-grow">
                    <h3 class="text-lg font-bold text-gray-900 mb-1 line-clamp-1">
                        <a href="/propiedad/<%= prop.id %>?fechaLlegada=<%= query.fechaLlegada || '' %>&fechaSalida=<%= query.fechaSalida || '' %>&personas=<%= query.personas || '' %>"
                            class="hover:text-indigo-600">
                            <% if (tienePrecio) { %><span class="text-green-600 mr-1">✓</span>
                                <% } %>
                                    <%= prop.nombre %>
                        </a>
                    </h3>
                    <p class="text-sm text-gray-600 mb-2"><i class="fas fa-user-friends mr-1"></i> Hasta <%=
                            prop.capacidad %> personas</p>

                    <% if (tienePrecio) { %>
                        <div class="mt-2 text-sm border-t pt-2">
                            <p class="text-gray-600 text-xs">Total por <%= prop.pricing.nights %> noche(s):</p>
                            <p class="text-xl font-bold text-gray-900">
                                <%= formatCurrency(prop.pricing.totalPriceCLP) %>
                            </p>
                            <% if (abono> 0) { %>
                                <p class="text-indigo-600 font-semibold text-xs mt-1">Reserva con solo <%=
                                        formatCurrency(abono) %>
                                </p>
                                <% } %>
                        </div>
                        <% } else if (!isSearchResult) { %>
                            <p class="text-sm text-gray-500 line-clamp-3">
                                <%= descripcion %>
                            </p>
                            <% } %>
                </div>
                <div class="text-right mt-4 pt-3 border-t border-gray-100">
                    <a href="/propiedad/<%= prop.id %>?fechaLlegada=<%= query.fechaLlegada || '' %>&fechaSalida=<%= query.fechaSalida || '' %>&personas=<%= query.personas || '' %>"
                        class="btn-secondary btn-sm w-full block text-center">
                        <%= tienePrecio ? 'Ver y Reservar' : 'Ver Detalles' %>
                    </a>
                </div>
            </div>
        </div>