<%- /* backend/views/home.ejs */ %>
    <!DOCTYPE html>
    <html lang="es">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>
            <%= empresa.websiteSettings?.seo?.homeTitle || empresa.nombre %>
        </title>
        <meta name="description"
            content="<%= empresa.websiteSettings?.seo?.homeDescription || `Reservas en ${empresa.nombre}` %>">

        <%# --- INICIO: Script JSON-LD (Home) --- %>
            <% if (locals.schemaData) { %>
                <script type="application/ld+json">
        <%- JSON.stringify(schemaData, null, 2) %>
    </script>
                <% } %>
                    <%# --- FIN: Script JSON-LD (Home) --- %>

                        <link rel="stylesheet" href="/public/css/website.css">
                        <link rel="preconnect" href="https://fonts.googleapis.com">
                        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
                            rel="stylesheet">
                        <link rel="stylesheet"
                            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    </head>

    <body class="bg-gray-50 flex flex-col min-h-screen">

        <%- include('partials/header') %>

            <main class="flex-grow overflow-hidden">
                <%# Sección Hero %>
                    <% if (empresa.websiteSettings?.theme?.heroImageUrl) { %>
                        <div class="relative h-[50vh] min-h-[400px] w-full overflow-hidden">
                            <picture>
                                <source srcset="<%= empresa.websiteSettings.theme.heroImageUrl %>" type="image/webp">
                                <img src="<%= empresa.websiteSettings.theme.heroImageUrl %>"
                                    alt="<%= empresa.websiteSettings.theme.heroImageAlt || 'Imagen de portada' %>"
                                    title="<%= empresa.websiteSettings.theme.heroImageTitle || empresa.nombre %>"
                                    class="w-full h-full object-cover">
                            </picture>
                            <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                            <div
                                class="absolute inset-0 flex flex-col justify-center items-start px-4 md:px-12 text-white container mx-auto">
                                <h1 class="text-4xl md:text-6xl font-bold drop-shadow-lg mb-4">
                                    <%= empresa.websiteSettings?.content?.homeH1 || empresa.nombre %>
                                </h1>
                                <p class="text-lg md:text-2xl max-w-2xl drop-shadow-md">
                                    <%= empresa.websiteSettings?.content?.homeIntro || empresa.slogan
                                        || 'Tu mejor opción para descansar.' %>
                                </p>
                            </div>
                        </div>
                        <% } else { %>
                            <div
                                class="bg-indigo-700 text-white py-12 px-4 text-center h-64 md:h-80 flex items-center justify-center">
                                <div>
                                    <h1 class="text-4xl md:text-5xl font-bold">
                                        <%= empresa.websiteSettings?.content?.homeH1 || empresa.nombre %>
                                    </h1>
                                    <p class="mt-4 text-lg md:text-xl max-w-2xl">
                                        <%= empresa.websiteSettings?.content?.homeIntro || empresa.slogan
                                            || 'Tu mejor opción para descansar.' %>
                                    </p>
                                </div>
                            </div>
                            <% } %>

                                <div class="container mx-auto px-4 py-12">
                                    <%# Formulario de Búsqueda (Partial) %>
                                        <%- include('partials/search-bar') %>

                                            <div id="propiedades">
                                                <h2 class="text-3xl font-bold text-gray-900 mb-8">
                                                    <% if (isSearchResult) { %>Resultados de la Búsqueda<% } else { %>
                                                            Nuestras Propiedades<% } %>
                                                </h2>
                                                <% const formatCurrency=(value)=> `$${(Math.round(value) ||
                                                    0).toLocaleString('es-CL')}`; %>

                                                    <% if (resultados.length> 0) { %>
                                                        <div
                                                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6">
                                                            <% resultados.forEach(item=> { %>
                                                                <% if (item.isGroup) { %>
                                                                    <%# --- Tarjeta de Grupo --- %>
                                                                        <% const grupo=item; const
                                                                            tienePrecioGrupo=grupo.combinedPricing &&
                                                                            typeof
                                                                            grupo.combinedPricing.totalPriceCLP==='number'
                                                                            && grupo.combinedPricing.totalPriceCLP> 0;
                                                                            let abonoGrupo = tienePrecioGrupo ?
                                                                            grupo.combinedPricing.totalPriceCLP * 0.10 :
                                                                            0;
                                                                            const idsPropiedades =
                                                                            grupo.properties.map(p => p.id).join(',');
                                                                            const linkReservaGrupo =
                                                                            `/reservar?propiedadId=${idsPropiedades}&fechaLlegada=${query.fechaLlegada||''}&fechaSalida=${query.fechaSalida||''}&personas=${query.personas||''}&noches=${grupo.combinedPricing.nights||''}&precioFinal=${tienePrecioGrupo?grupo.combinedPricing.totalPriceCLP:''}`;
                                                                            %>
                                                                            <div
                                                                                class="bg-white rounded-lg shadow-xl border-2 border-indigo-600 overflow-hidden col-span-1 sm:col-span-2 lg:col-span-4 xl:col-span-6">
                                                                                <div class="p-4 md:p-6">
                                                                                    <h3
                                                                                        class="text-2xl font-bold text-gray-900 mb-2">
                                                                                        <span
                                                                                            class="text-green-600 mr-1">✓</span>¡Grupo
                                                                                        Sugerido para <%= query.personas
                                                                                            %> personas!
                                                                                    </h3>
                                                                                    <p
                                                                                        class="text-sm text-gray-600 mb-4">
                                                                                        Encontramos la combinación
                                                                                        perfecta de <%=
                                                                                            grupo.properties.length %>
                                                                                            propiedades para tu estadía.
                                                                                    </p>
                                                                                    <div
                                                                                        class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                                                        <div
                                                                                            class="md:col-span-1 border-r-0 md:border-r md:pr-6">
                                                                                            <h4
                                                                                                class="text-lg font-semibold mb-2">
                                                                                                Resumen del Grupo</h4>
                                                                                            <% if (tienePrecioGrupo) {
                                                                                                %>
                                                                                                <div class="space-y-2">
                                                                                                    <div
                                                                                                        class="flex justify-between text-sm">
                                                                                                        <span>Capacidad
                                                                                                            Total:</span>
                                                                                                        <span
                                                                                                            class="font-semibold">
                                                                                                            <%= grupo.combinedCapacity
                                                                                                                %>
                                                                                                                personas
                                                                                                        </span>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="flex justify-between text-sm">
                                                                                                        <span>Total
                                                                                                            Noches:</span>
                                                                                                        <span
                                                                                                            class="font-semibold">
                                                                                                            <%= grupo.combinedPricing.nights
                                                                                                                %>
                                                                                                        </span>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="border-t pt-2 mt-2">
                                                                                                        <div
                                                                                                            class="flex justify-between text-lg font-bold text-gray-900">
                                                                                                            <span>Total
                                                                                                                Estadía:</span>
                                                                                                            <span>
                                                                                                                <%= formatCurrency(grupo.combinedPricing.totalPriceCLP)
                                                                                                                    %>
                                                                                                            </span>
                                                                                                        </div>
                                                                                                        <div
                                                                                                            class="flex justify-between text-indigo-600 font-semibold text-sm">
                                                                                                            <span>Abono
                                                                                                                (10%):</span>
                                                                                                            <span>
                                                                                                                <%= formatCurrency(abonoGrupo)
                                                                                                                    %>
                                                                                                            </span>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <a href="<%= linkReservaGrupo %>"
                                                                                                        class="btn w-full mt-4">Reservar
                                                                                                        Grupo</a>
                                                                                                </div>
                                                                                                <% } else { %>
                                                                                                    <p
                                                                                                        class="text-red-500">
                                                                                                        Error al
                                                                                                        calcular precio.
                                                                                                    </p>
                                                                                                    <% } %>
                                                                                        </div>
                                                                                        <div class="md:col-span-2">
                                                                                            <h4
                                                                                                class="text-lg font-semibold mb-3">
                                                                                                Propiedades Incluidas
                                                                                            </h4>
                                                                                            <div class="space-y-3">
                                                                                                <%
                                                                                                    grupo.properties.forEach(prop=>
                                                                                                    { %>
                                                                                                    <% const
                                                                                                        imgUrl=prop.websiteData?.cardImage?.storagePath
                                                                                                        || 'https://via.placeholder.com/150x100.png?text=Sin+Imagen'
                                                                                                        ; %>
                                                                                                        <div
                                                                                                            class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg">
                                                                                                            <img src="<%= imgUrl %>"
                                                                                                                alt="<%= prop.nombre %>"
                                                                                                                class="w-20 h-14 object-cover rounded-md flex-shrink-0">
                                                                                                            <div>
                                                                                                                <h5
                                                                                                                    class="font-semibold text-sm text-gray-800">
                                                                                                                    <%= prop.nombre
                                                                                                                        %>
                                                                                                                </h5>
                                                                                                                <p
                                                                                                                    class="text-xs text-gray-600">
                                                                                                                    Capacidad:
                                                                                                                    <%= prop.capacidad
                                                                                                                        %>
                                                                                                                        personas
                                                                                                                </p>
                                                                                                                <p
                                                                                                                    class="card-description text-xs text-gray-600 mt-1">
                                                                                                                    <%= (prop.websiteData?.aiDescription
                                                                                                                        ||
                                                                                                                        prop.descripcion
                                                                                                                        || ''
                                                                                                                        ).substring(0,
                                                                                                                        100)
                                                                                                                        %>
                                                                                                                        ...
                                                                                                                </p>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        <% }) %>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <% } else { %>
                                                                                <%# --- Tarjeta Individual (Partial) ---
                                                                                    %>
                                                                                    <%- include('partials/property-card',
                                                                                        { prop: item, query: query,
                                                                                        isSearchResult: isSearchResult
                                                                                        }) %>
                                                                                        <% } %>
                                                                                            <% }) %>
                                                        </div>
                                                        <% } else { %>
                                                            <%# Mensaje "No encontrado" %>
                                                                <div
                                                                    class="text-center py-12 px-4 border-2 border-dashed rounded-lg">
                                                                    <h3 class="text-xl font-semibold text-gray-700">No
                                                                        se encontraron propiedades</h3>
                                                                    <p class="mt-2 text-sm text-gray-500">
                                                                        <% if (isSearchResult) { %>
                                                                            No hay propiedades disponibles que cumplan
                                                                            los criterios. Intenta con otras fechas o
                                                                            menos huéspedes.
                                                                            <% } else { %>
                                                                                <% const
                                                                                    propiedadesListadasConImagen=resultados.some(p=>
                                                                                    !p.isGroup &&
                                                                                    p.googleHotelData?.isListed &&
                                                                                    p.websiteData?.cardImage?.storagePath);
                                                                                    const algunaPropiedadListada =
                                                                                    resultados.some(p => !p.isGroup &&
                                                                                    p.googleHotelData?.isListed);
                                                                                    %>
                                                                                    <% if (algunaPropiedadListada &&
                                                                                        !propiedadesListadasConImagen) {
                                                                                        %>
                                                                                        No hay propiedades configuradas
                                                                                        con "Imagen Principal
                                                                                        (Tarjeta/Home)" para mostrar.
                                                                                        Revisa "Configurar Web Pública".
                                                                                        <% } else if
                                                                                            (!algunaPropiedadListada &&
                                                                                            !isSearchResult) { %>
                                                                                            Actualmente no hay
                                                                                            propiedades marcadas para
                                                                                            mostrarse en la web pública.
                                                                                            Revisa "Gestionar
                                                                                            Alojamientos".
                                                                                            <% } else if
                                                                                                (!isSearchResult) { %>
                                                                                                Parece que no hay
                                                                                                propiedades configuradas
                                                                                                para mostrar.
                                                                                                <% } %>
                                                                                                    <% } %>
                                                                    </p>
                                                                </div>
                                                                <% } %>
                                            </div>
                                </div>
            </main>

            <%- include('partials/footer') %>

    </body>

    </html>